<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Famidash Builds</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  #build-list { list-style: none; padding: 0; }
  .build-row { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #ccc; }
  .build-info span { margin-right: 10px; }
  .save-button { text-decoration: none; font-size: 16px; }
  #pagination { margin-top: 10px; }
  button { margin: 0 5px; }
</style>
</head>
<body>

<h1>Famidash Builds</h1>
<ul id="build-list"></ul>

<div id="pagination">
  <button id="prev-page">Prev</button>
  <span id="page-info"></span>
  <button id="next-page">Next</button>
</div>

<script>
const buildsPerPage = 10;
let currentPage = 1;
let allBuilds = [];
let romFiles = [];

const RAW_INFO_URL = "https://raw.githubusercontent.com/Auro-7/famidash-collection/main/info.ini";
const GITHUB_CONTENT_URL = "https://api.github.com/repos/Auro-7/famidash-collection/contents";

// Fetch ROM filenames from GitHub
async function fetchRomFiles() {
  const res = await fetch(GITHUB_CONTENT_URL);
  const files = await res.json();
  romFiles = files.filter(f => f.name.endsWith('.nes')).map(f => f.name);
}

// Parse info.ini
async function fetchBuilds() {
  await fetchRomFiles();

  const res = await fetch(RAW_INFO_URL);
  const text = await res.text();

  const lines = text.split('\n');
  let currentEntry = null;
  allBuilds = [];

  for (let line of lines) {
    line = line.trim();
    if (!line || line.startsWith('#')) continue;

    const sectionMatch = line.match(/^\[(.+?)\]$/);
    if (sectionMatch) {
      if (currentEntry) allBuilds.push(currentEntry);
      currentEntry = { title: sectionMatch[1] };
      continue;
    }

    const kv = line.split('=');
    if (kv.length === 2 && currentEntry) {
      const key = kv[0].trim();
      const value = kv[1].trim().replace(/^"|"$/g, '');
      currentEntry[key] = value;
    }
  }
  if (currentEntry) allBuilds.push(currentEntry);

  // Assign ROM to each entry
  const assignedRoms = new Set();
  allBuilds = allBuilds.map(entry => {
    let matched = null;

    // UV3 entries â†’ match by segment 3
    if (entry.uv3 === 'true') {
      matched = romFiles.find(f => {
        const segments = f.split('.');
        return segments[2] && !assignedRoms.has(f);
      });
    } else {
      // Regular builds â†’ match the first unassigned ROM
      matched = romFiles.find(f => !assignedRoms.has(f));
    }

    if (matched) assignedRoms.add(matched);

    return {
      display_name: entry.title,
      date: entry.date || '-',
      url: matched ? `https://raw.githubusercontent.com/Auro-7/famidash-collection/main/${matched}` : '#',
      commit: matched ? matched.split('.')[2] || '-' : '-'
    };
  });

  renderPage(currentPage);
}

// Render page
function renderPage(page) {
  const list = document.getElementById('build-list');
  list.innerHTML = '';
  const start = (page - 1) * buildsPerPage;
  const end = start + buildsPerPage;
  const pageBuilds = allBuilds.slice(start, end);

  pageBuilds.forEach(build => {
    const li = document.createElement('li');
    li.className = 'build-row';

    const info = document.createElement('div');
    info.className = 'build-info';

    const name = document.createElement('span'); name.textContent = build.display_name;
    const date = document.createElement('span'); date.textContent = build.date;
    const commit = document.createElement('span'); commit.textContent = build.commit;

    info.appendChild(name);
    info.appendChild(date);
    info.appendChild(commit);

    const link = document.createElement('a');
    link.className = 'save-button';
    link.href = build.url;
    link.setAttribute('download', '');
    link.textContent = 'ðŸ’¾';

    li.appendChild(info);
    li.appendChild(link);
    list.appendChild(li);
  });

  document.getElementById('page-info').textContent =
    `Page ${currentPage} of ${Math.ceil(allBuilds.length / buildsPerPage)}`;
}

// Pagination
document.getElementById('prev-page').addEventListener('click', () => {
  if (currentPage > 1) { currentPage--; renderPage(currentPage); }
});
document.getElementById('next-page').addEventListener('click', () => {
  if (currentPage < Math.ceil(allBuilds.length / buildsPerPage)) { currentPage++; renderPage(currentPage); }
});

// Initial fetch
fetchBuilds();
</script>

</body>
</html>
